apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: tracc-prod  # Override all base namespaces to match ArgoCD destination

# Reference the base configuration and AWS-specific resources
resources:
  - ../../base
  - ingress.yaml
  - external-secrets-patch.yaml  # K3s-compatible External Secrets using ClusterSecretStore

# Patches for AWS environment
patchesStrategicMerge:
  - patches/expense-patch.yaml
  - patches/user-patch.yaml
  - patches/ui-patch.yaml

patches:
  # Add serviceAccount to all deployments
  - target:
      kind: Deployment
    patch: |-
      - op: add
        path: /spec/template/spec/serviceAccountName
        value: tracc-app-sa
  # Remove SecretStore (K3s uses EC2 instance profile via ClusterSecretStore)
  - target:
      kind: SecretStore
      name: aws-secrets-store
    patch: |-
      apiVersion: external-secrets.io/v1beta1
      kind: SecretStore
      metadata:
        name: aws-secrets-store
        $patch: delete
  # Remove ServiceAccount (not needed for EC2 instance profile auth)
  - target:
      kind: ServiceAccount
      name: tracc-external-secrets-sa
    patch: |-
      apiVersion: v1
      kind: ServiceAccount
      metadata:
        name: tracc-external-secrets-sa
        $patch: delete

# Update images to latest versions
images:
  - name: ghcr.io/khushal1198/tracc-expense
    newTag: master-955954e
  - name: ghcr.io/khushal1198/tracc-user
    newTag: master-955954e
  - name: ghcr.io/khushal1198/tracc-ui
    newTag: master-955954e

# AWS-specific labels
labels:
  - pairs:
      environment: production
      cloud-provider: aws