apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: khushal-apps  # Using shared namespace

bases:
  - ../../base

resources:
  - ingress.yaml

patches:
  - path: patches/timeline-patch.yaml
    target:
      kind: Deployment
      name: swaminarayan-timeline-timeline
  - path: patches/contributor-patch.yaml
    target:
      kind: Deployment
      name: swaminarayan-timeline-contributor
  - path: patches/ui-patch.yaml
    target:
      kind: Deployment
      name: swaminarayan-timeline-ui
  # K3s compatibility - use ClusterSecretStore instead of namespace SecretStore
  - path: external-secrets-patch.yaml
    target:
      kind: ExternalSecret
      name: ghcr-credentials
  # Remove SecretStore (K3s uses EC2 instance profile via ClusterSecretStore)
  - target:
      kind: SecretStore
      name: aws-secrets-store
    patch: |-
      apiVersion: external-secrets.io/v1beta1
      kind: SecretStore
      metadata:
        name: aws-secrets-store
        $patch: delete
  # Remove ServiceAccount (not needed for EC2 instance profile auth)
  - target:
      kind: ServiceAccount
      name: tracc-external-secrets-sa
    patch: |-
      apiVersion: v1
      kind: ServiceAccount
      metadata:
        name: tracc-external-secrets-sa
        $patch: delete

images:
  - name: ghcr.io/khushal1198/swaminarayan-timeline-timeline
    newTag: main-3ece5ce
  - name: ghcr.io/khushal1198/swaminarayan-timeline-contributor
    newTag: main-3ece5ce
  - name: ghcr.io/khushal1198/swaminarayan-timeline-ui
    newTag: main-3ece5ce

commonLabels:
  environment: production
  region: us-east-1

configMapGenerator:
  - name: swaminarayan-timeline-env-config
    literals:
      - AWS_REGION=us-east-1
      - ENVIRONMENT=production
      - LOG_LEVEL=info

secretGenerator:
  - name: swaminarayan-timeline-secrets
    literals:
      - database-url=postgresql://user:pass@postgres:5432/swaminarayan_timeline  # Placeholder
      - jwt-secret=your-jwt-secret-here  # Placeholder